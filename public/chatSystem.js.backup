// chatSystem.js - ãƒãƒ£ãƒƒãƒˆãƒ»å¯¾è©±ã‚·ã‚¹ãƒ†ãƒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ç­”ã®æ¡æ–‡å‡¦ç†å¯¾å¿œï¼‰

import { processArticleReferences, processAllReferences, setupArticleRefButtons } from './articleProcessor.js';
import { characters, generateLocationNarration, getGlobalRulesAsText, getGlobalHonorificRulesAsText, getStoryContextRulesAsText, getOutputFormatRules, getLocationManagementRules, getSessionTypeInstructions, getBasicConversationRules, getArticleReferenceRules, getFollowUpLocationRules } from './data/characters.js';
import { generateInitialPrompt, generateCharacterPersonaPrompt } from './data/prompts.js';

// â˜…â˜…â˜… ãƒãƒ£ãƒƒãƒˆçµ‚äº†ãƒ»ãƒªã‚»ãƒƒãƒˆå‡¦ç†ï¼ˆåŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢å¯¾å¿œï¼‰ â˜…â˜…â˜…
export function endChatSession(sessionId) {
    console.log('ğŸ”š ãƒãƒ£ãƒƒãƒˆçµ‚äº†å‡¦ç†é–‹å§‹:', sessionId);
    
    // åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ç‰¹åˆ¥å‡¦ç†
    const embeddedChatArea = document.getElementById('embedded-chat-area');
    if (embeddedChatArea) {
        embeddedChatArea.style.display = 'none';
        embeddedChatArea.innerHTML = '';
        console.log('âœ… åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ');
    }
    
    // é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã®å‡¦ç†
    const chatArea = document.querySelector(`#chat-area-${sessionId}`);
    if (chatArea) {
        chatArea.style.display = 'none';
        chatArea.innerHTML = '';
    }
    
    // å¯¾è©±ã‚¨ãƒªã‚¢ã®å‡¦ç†
    const dialogueArea = document.querySelector(`#dialogue-area-${sessionId}`);
    if (dialogueArea) {
        dialogueArea.innerHTML = '';
    }
    
    // ä¼šè©±å±¥æ­´ã®ã‚¯ãƒªã‚¢
    if (window.conversationHistories && window.conversationHistories[sessionId]) {
        delete window.conversationHistories[sessionId];
    }
    
    console.log('âœ… ãƒãƒ£ãƒƒãƒˆçµ‚äº†å‡¦ç†å®Œäº†:', sessionId);
}

export function resetChatSession(sessionId) {
    console.log('ğŸ”„ ãƒãƒ£ãƒƒãƒˆãƒªã‚»ãƒƒãƒˆå‡¦ç†é–‹å§‹:', sessionId);
    
    // åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ç‰¹åˆ¥å‡¦ç†
    const embeddedChatArea = document.getElementById('embedded-chat-area');
    if (embeddedChatArea) {
        embeddedChatArea.style.display = 'none';
        embeddedChatArea.innerHTML = '';
        console.log('âœ… åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ');
    }
    
    // é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã®ãƒªã‚»ãƒƒãƒˆ
    const chatArea = document.querySelector(`#chat-area-${sessionId}`);
    if (chatArea) {
        chatArea.innerHTML = '';
    }
    
    // å¯¾è©±ã‚¨ãƒªã‚¢ã®ãƒªã‚»ãƒƒãƒˆ
    const dialogueArea = document.querySelector(`#dialogue-area-${sessionId}`);
    if (dialogueArea) {
        dialogueArea.innerHTML = '';
    }
    
    // ä¼šè©±å±¥æ­´ã®ãƒªã‚»ãƒƒãƒˆ
    if (window.conversationHistories && window.conversationHistories[sessionId]) {
        window.conversationHistories[sessionId] = [];
    }
    
    // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®å¾©å…ƒ
    const inputForm = document.querySelector(`#input-form-${sessionId}`);
    if (inputForm) {
        inputForm.style.display = 'block';
    }
    
    console.log('âœ… ãƒãƒ£ãƒƒãƒˆãƒªã‚»ãƒƒãƒˆå‡¦ç†å®Œäº†:', sessionId);
}

// â˜…â˜…â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ç­”ã®æ¡æ–‡ãƒ»Q&Aå‚ç…§å‡¦ç†ï¼ˆæ–°æ©Ÿèƒ½ï¼‰ â˜…â˜…â˜…
function processCharacterDialogue(dialogueText, supportedLaws = [], questionsAndAnswers = []) {
    // â˜…â˜…â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å›ç­”ã§æ¡æ–‡ã‚’ã€ã€‘ã§å›²ã‚€å‡¦ç†ã‚’æœ€åˆã«å®Ÿè¡Œ â˜…â˜…â˜…
    const lawsToUse = supportedLaws.length > 0 ? [...supportedLaws, 'æ†²æ³•', 'æ—¥æœ¬å›½æ†²æ³•'] : [
        'æ†²æ³•', 'æ—¥æœ¬å›½æ†²æ³•', 'æ°‘æ³•', 'ä¼šç¤¾æ³•', 'åˆ‘æ³•', 'å•†æ³•', 'æ°‘äº‹è¨´è¨Ÿæ³•', 'åˆ‘äº‹è¨´è¨Ÿæ³•', 
        'è¡Œæ”¿æ³•', 'åŠ´åƒåŸºæº–æ³•', 'ç‹¬å ç¦æ­¢æ³•', 'éº»è–¬åŠã³å‘ç²¾ç¥è–¬å–ç· æ³•'
    ];
    
    const uniqueLaws = [...new Set(lawsToUse)];
    
    // ã€ã€‘ã§å›²ã¾ã‚Œã¦ã„ãªã„æ¡æ–‡ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºã—ã¦ã€ã€‘ã§å›²ã‚€
    const lawPattern = uniqueLaws.map(law => law.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
    const unbracketed = new RegExp(`(?<!ã€)(${lawPattern})([0-9]+(?:ã®[0-9]+)?æ¡(?:ç¬¬?[0-9]+é …)?(?:[0-9]+å·)?)(?!ã€‘)`, 'g');
    
    let processedText = dialogueText.replace(unbracketed, 'ã€$1$2ã€‘');
    
    // ã€ã€‘ã§å›²ã‚“ã å¾Œã«ã€ä¸€åº¦ã ã‘çµ±åˆå‡¦ç†ã‚’å®Ÿè¡Œ
    processedText = processAllReferences(processedText, supportedLaws, questionsAndAnswers);
    
    return processedText;
}

// â˜…â˜…â˜… ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆè¤‡æ•°å°å•å¯¾å¿œï¼‰ â˜…â˜…â˜…
export async function startChatSession(button, currentCaseData) {
    console.log('=== startChatSessioné–‹å§‹ï¼ˆstory/explanationå¯¾å¿œï¼‰ ===');
    
    // é‡è¤‡å®Ÿè¡Œé˜²æ­¢
    if (button.disabled || button.classList.contains('processing')) {
        console.log('âš ï¸ å‡¦ç†ä¸­ã®ãŸã‚å®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—');
        return;
    }
    
    // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    button.disabled = true;
    button.classList.add('processing');
    const originalText = button.textContent;
    button.textContent = 'å‡¦ç†ä¸­...';
    
    const type = button.dataset.type;
    let container, inputForm, inputElement, chatArea;
    
    try {
        // åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã®ç‰¹åˆ¥å‡¦ç†ã‚’å…ˆã«ç¢ºèª
        const embeddedChatArea = document.getElementById('embedded-chat-area');
        if (embeddedChatArea && embeddedChatArea.style.display !== 'none') {
            console.log('ğŸ” åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã‚’ä½¿ç”¨ã—ã¦ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹');
            
            // å¸æ³•è©¦é¨“ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¾ãŸã¯é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‹ã‚‰å–å¾—
            const judicialTextarea = document.getElementById('judicial-answer-textarea');
            if (judicialTextarea && judicialTextarea.value.trim()) {
                const mockInput = document.createElement('textarea');
                mockInput.value = judicialTextarea.value.trim();
                inputElement = mockInput;
                chatArea = embeddedChatArea;
                inputForm = document.createElement('div'); // ãƒ€ãƒŸãƒ¼ã®inputForm
                container = embeddedChatArea.parentElement; // è¦ªè¦ç´ ã‚’containerã¨ã™ã‚‹
                
                // åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢å°‚ç”¨ã®å¯¾è©±ã‚¨ãƒªã‚¢ã‚’ä½œæˆ
                embeddedChatArea.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg border animate-fade-in">
                        <h4 class="text-lg font-bold mb-3">ğŸ­ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®å¯¾è©±</h4>
                        <div id="dialogue-area-embedded-dialogue" class="space-y-4 max-h-[50vh] overflow-y-auto p-4 bg-white border rounded-lg custom-scrollbar">
                            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾è©±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                `;
                console.log('âœ… åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆç”¨å¯¾è©±ã‚¨ãƒªã‚¢ä½œæˆå®Œäº†');
            } else {
                console.error('ç­”æ¡ˆãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                embeddedChatArea.innerHTML = '<div class="text-center text-red-600 p-4">âŒ ç­”æ¡ˆãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                return;
            }
        } else {
            // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦é©åˆ‡ãªè¦ç´ ã‚’å–å¾—
            if (type === 'story') {
                container = document.getElementById('tab-story-content');
                inputElement = document.getElementById('story-question-input');
                inputForm = inputElement ? inputElement.closest('.input-form') : null;
                chatArea = document.getElementById('chat-area-story');
            } else if (type === 'explanation') {
                container = document.getElementById('tab-explanation-content');
                inputElement = document.getElementById('explanation-question-input');
                inputForm = inputElement ? inputElement.closest('.input-form') : null;
                chatArea = document.getElementById('chat-area-explanation');
            } else {
                // å¾“æ¥ã®quiz/essayå‡¦ç†
                container = button.closest('.prose-bg');
                if (container) {
                    inputForm = container.querySelector('.input-form');
                inputElement = container.querySelector('textarea');
                chatArea = container.querySelector('.chat-area');
            }
        }
        
        if (!inputForm || !inputElement || !chatArea) {
            console.error('è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: å¿…è¦ãªUIè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', { type, container, inputForm, inputElement, chatArea });
            return;
        }
        
        // å¤‰æ•°ã‚’å…ˆã«å®šç¾©ï¼ˆé‡è¤‡å®£è¨€ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰
        // type ã¯é–¢æ•°é–‹å§‹æ™‚ã«æ—¢ã«å®šç¾©æ¸ˆã¿
        const quizIndex = button.dataset.quizIndex;
        const subIndex = button.dataset.subIndex || '0'; // è¤‡æ•°å°å•å¯¾å¿œ
        
        // â˜…â˜…â˜… ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’è¤‡æ•°å°å•å¯¾å¿œã«å¤‰æ›´ï¼ˆstoryã€explanationã€åŸ‹ã‚è¾¼ã¿å¯¾å¿œï¼‰ â˜…â˜…â˜…
        let sessionId;
        if (embeddedChatArea && embeddedChatArea.style.display !== 'none') {
            sessionId = 'embedded-dialogue'; // åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆå°‚ç”¨ID
        } else if (type === 'quiz') {
            sessionId = `quiz-${quizIndex}-${subIndex}`;
        } else if (type === 'story') {
            sessionId = 'story';
        } else if (type === 'explanation') {
            sessionId = 'explanation';
        } else {
            sessionId = 'essay';
        }

        const userInput = inputElement.value.trim();
        if (userInput.length < 10) {
            if (embeddedChatArea) {
                embeddedChatArea.innerHTML = '<div class="text-center text-yellow-600 p-4">âš ï¸ ã‚‚ã†å°‘ã—è©³ã—ãè¨˜è¿°ã—ã¦ãã ã•ã„ï¼ˆ10æ–‡å­—ä»¥ä¸Šï¼‰</div>';
            } else {
                alert('ã‚‚ã†å°‘ã—è©³ã—ãè¨˜è¿°ã—ã¦ãã ã•ã„ï¼ˆ10æ–‡å­—ä»¥ä¸Šï¼‰ã€‚');
            }
            return;
        }

        // åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã§ãªã„å ´åˆã®ã¿ãƒ•ã‚©ãƒ¼ãƒ éè¡¨ç¤º
        if (sessionId !== 'embedded-dialogue') {
            inputForm.style.display = 'none';
        }
        chatArea.style.display = 'block';
        
        let problemText, modelAnswer, hintText, chatTitle;
        if (type === 'quiz') {
            const quizGroup = currentCaseData.quiz[quizIndex];
            
            // æ—§å½¢å¼ã¨ã®äº’æ›æ€§
            if (quizGroup.problem && !quizGroup.subProblems) {
                problemText = quizGroup.problem;
                modelAnswer = quizGroup.modelAnswer || '';
                hintText = '';
            } else {
                // æ–°å½¢å¼ï¼šè¤‡æ•°å°å•
                const subProblem = quizGroup.subProblems[parseInt(subIndex)];
                problemText = subProblem.problem;
                modelAnswer = subProblem.modelAnswer || '';
                hintText = '';
            }
            chatTitle = 'ğŸ“ ãƒŸãƒ‹è«–æ–‡æ·»å‰Š';
        } else if (type === 'story') {
            problemText = `ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å†…å®¹ï¼š${currentCaseData.story.map(s => s.type === 'dialogue' ? `${s.speaker}: ${s.dialogue}` : s.text).join('\n')}`;
            modelAnswer = currentCaseData.knowledgeBox || '';
            hintText = '';
            chatTitle = 'ğŸ’¬ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼Q&A';
        } else if (type === 'explanation') {
            problemText = `è§£èª¬å†…å®¹ï¼š${currentCaseData.explanation}`;
            modelAnswer = currentCaseData.knowledgeBox || '';
            hintText = '';
            chatTitle = 'ğŸ¤” è§£èª¬Q&A';
        } else {
            problemText = currentCaseData.essay.question;
            modelAnswer = currentCaseData.essay.points.join('ã€');
            hintText = `<h5 class="font-bold mb-2">ç­”æ¡ˆæ§‹æˆã®ãƒ’ãƒ³ãƒˆ</h5><ul class="list-disc list-inside bg-gray-100 p-4 rounded-lg mb-4 text-sm space-y-1">${currentCaseData.essay.points.map(p => `<li>${p}</li>`).join('')}</ul>`;
            chatTitle = 'âœï¸ è«–æ–‡ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°';
        }
        // åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ä»¥å¤–ã®å ´åˆã®ã¿chatAreaã®innerHTMLã‚’è¨­å®š
        if (sessionId !== 'embedded-dialogue') {
            chatArea.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg border animate-fade-in">
                    <h4 class="text-lg font-bold mb-3">${chatTitle}</h4>
                    <div id="dialogue-area-${sessionId}" class="space-y-4 max-h-[50vh] overflow-y-auto p-4 bg-white border rounded-lg custom-scrollbar">
                        <!-- åˆæœŸè¡¨ç¤ºã¯ç©º -->
                    </div>
                    <div class="mt-4 flex gap-2">
                        <textarea id="chat-follow-up-input-${sessionId}" class="w-full p-4 border rounded-lg focus-ring" style="height: 120px; resize: none;" placeholder="ã•ã‚‰ã«è³ªå•ã‚„åè«–ã‚’ã©ã†ãâ€¦"></textarea>
                        <div class="flex flex-col gap-2">
                            <button id="send-follow-up-btn-${sessionId}" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg btn-hover" data-session-id="${sessionId}">é€ä¿¡</button>
                            <button id="end-chat-btn-${sessionId}" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-4 rounded-lg btn-hover text-sm" data-session-id="${sessionId}">çµ‚äº†</button>
                        </div>
                    </div>
                </div>        `;
        }
        
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆå‡¦ç†
        let initialPrompt;
        if (type === 'story' || type === 'explanation') {
            // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ»è§£èª¬Q&Aç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            const basePrompt = generateQAPrompt(userInput, problemText, modelAnswer, currentCaseData, type);
            initialPrompt = generateCharacterAwarePrompt(basePrompt, currentCaseData, type);
        } else {
            // å¾“æ¥ã®æ·»å‰Šç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
            const characterNames = [...new Set(currentCaseData.story.filter(s => s.type === 'dialogue').map(s => s.speaker))];
            const locationNarration = generateLocationNarration(characterNames);
            
            // åŸºæœ¬ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å–å¾—ã—ã¦ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ±åˆ
            const basePrompt = generateInitialPrompt(userInput, problemText, modelAnswer, currentCaseData);
            const narrativePrompt = integrateLocationNarration(basePrompt, locationNarration);
            initialPrompt = generateCharacterAwarePrompt(narrativePrompt, currentCaseData);
        }

        if (!window.conversationHistories) window.conversationHistories = {};
        
        let initialMessage;
        if (type === 'story' || type === 'explanation') {
            initialMessage = { role: 'user', parts: [{ text: `æ¬¡ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚è³ªå•ï¼š${userInput}` }] };
        } else {
            initialMessage = { role: 'user', parts: [{ text: `ç­”æ¡ˆã‚’æ·»å‰Šã—ã¦ãã ã•ã„ã€‚ç­”æ¡ˆï¼š${userInput}` }] };
        }
        
        window.conversationHistories[sessionId] = [initialMessage];
        
        await sendMessageToAI(sessionId, initialPrompt, problemText, userInput);

    } catch (error) {
        console.error('âŒ startChatSessionã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
        if (inputForm) inputForm.style.display = 'block';
        if (chatArea) {
            chatArea.style.display = 'none';
            chatArea.innerHTML = '';
        }
    } finally {
        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
        button.disabled = false;
        button.classList.remove('processing');
        button.textContent = originalText;
    }
}


// â˜…â˜…â˜… AIã¨ã®é€šä¿¡ã‚’ç®¡ç†ã™ã‚‹ä¸­æ ¸é–¢æ•° â˜…â˜…â˜…
export async function sendMessageToAI(sessionId, promptText, problemText, userInput) {
    const dialogueArea = document.getElementById(`dialogue-area-${sessionId}`);
    if (!dialogueArea) return;

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼ˆè¿½è¨˜ç”¨ï¼‰
    const followUpLoaderId = `follow-up-loader-${Date.now()}`;
    dialogueArea.insertAdjacentHTML('beforeend', `<div id="${followUpLoaderId}" class="text-center p-2"><div class="loader-small mx-auto"></div></div>`);
    dialogueArea.scrollTop = dialogueArea.scrollHeight;

    try {
        const history = window.conversationHistories[sessionId] || [];

        const response = await fetch('/api/gemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json; charset=UTF-8' },
            body: JSON.stringify({
                prompt: promptText,
                history: history,
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}. è©³ç´°: ${errorData.detail || 'ãªã—'}`);
        }
        
        const result = await response.json();
        const aiResponse = result.text.trim();

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’å‰Šé™¤
        const loaderToRemove = document.getElementById(followUpLoaderId) || document.getElementById(`loading-indicator-${sessionId}`);
        if (loaderToRemove) loaderToRemove.remove();        window.conversationHistories[sessionId].push({ role: 'model', parts: [{ text: aiResponse }] });

        // AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‰å‡¦ç†ï¼šãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã‚’åˆ†é›¢
        let processedResponse = aiResponse;
        
        // ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘å½¢å¼ã®å‡¦ç†
        const narrationMatch = processedResponse.match(/^ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘(.+?)(?=\n|$)/);
        if (narrationMatch) {
            const narrationPart = narrationMatch[0];
            const remainingPart = processedResponse.replace(narrationMatch[0], '').trim();
            processedResponse = narrationPart + (remainingPart ? '---' + remainingPart : '');
        }
        
        // æ··åœ¨ã—ãŸãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‹å¯¾è©±ã®å‡¦ç†
        processedResponse = processedResponse.replace(/^(.+?ã€‚.+?ã€‚)\s+([^ã€‚]+@[^:]+:.*)$/gm, '$1---$2');        const dialogues = processedResponse.split('---').filter(d => d.trim() !== '');
        for (const dialogue of dialogues) {
            await sleep(1500);
            displaySingleDialogue(dialogue, sessionId);
        }
        
        // â˜…â˜…â˜… å…¨ã¦ã®å¯¾è©±è¡¨ç¤ºå®Œäº†å¾Œã«MermaidåˆæœŸåŒ– â˜…â˜…â˜…
        setTimeout(() => {
            initializeChatMermaid();
        }, 500); // æœ€å¾Œã®å¯¾è©±è¡¨ç¤ºã‚’å¾…ã¤// â˜…â˜…â˜… æ”¹è‰¯ã•ã‚ŒãŸã‚¹ã‚³ã‚¢æŠ½å‡ºã¨ãƒ‡ãƒãƒƒã‚° â˜…â˜…â˜…
        console.log('ğŸ” AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚¹ã‚³ã‚¢æ¤œç´¢ç”¨ï¼‰:', aiResponse.substring(0, 500));
        
        // ã‚ˆã‚ŠæŸ”è»Ÿãªã‚¹ã‚³ã‚¢æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
        const scorePatterns = [
            /\*\*(\d+)ç‚¹\*\*/,  // å…ƒã®ãƒ‘ã‚¿ãƒ¼ãƒ³
            /(\d+)ç‚¹/,           // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‘ã‚¿ãƒ¼ãƒ³
            /ç‚¹æ•°[ï¼š:]\s*(\d+)/,  // ã€Œç‚¹æ•°ï¼šXXã€å½¢å¼
            /ã‚¹ã‚³ã‚¢[ï¼š:]\s*(\d+)/, // ã€Œã‚¹ã‚³ã‚¢ï¼šXXã€å½¢å¼
            /è©•ä¾¡[ï¼š:]\s*(\d+)ç‚¹/ // ã€Œè©•ä¾¡ï¼šXXç‚¹ã€å½¢å¼
        ];
        
        let score = null;
        for (const pattern of scorePatterns) {
            const match = aiResponse.match(pattern);
            if (match) {
                score = parseInt(match[1], 10);
                console.log(`âœ… ã‚¹ã‚³ã‚¢æ¤œå‡ºæˆåŠŸ: ${score}ç‚¹ (ãƒ‘ã‚¿ãƒ¼ãƒ³: ${pattern})`);
                break;
            }
        }
        
        if (score !== null) {
            console.log(`ğŸ“Š æ¤œå‡ºã•ã‚ŒãŸã‚¹ã‚³ã‚¢: ${score}ç‚¹`);
            // ä¿å­˜æ¡ä»¶ã‚’ç·©å’Œï¼š10ç‚¹ä»¥ä¸Šã§ä¿å­˜
            if (score >= 10) {
                console.log(`ğŸ’¾ ä¿å­˜æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™ (${score}ç‚¹ >= 10ç‚¹)`);
                await saveUserAnswer(sessionId, userInput, score, problemText);
            } else {
                console.log(`âš ï¸ ä¿å­˜æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ (${score}ç‚¹ < 10ç‚¹)`);
            }
        } else {
            console.log('âš ï¸ ã‚¹ã‚³ã‚¢ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å¹³å‡ã‚¹ã‚³ã‚¢(50ç‚¹)ã§ä¿å­˜ã—ã¾ã™ã€‚');
            // ã‚¹ã‚³ã‚¢ãŒæ¤œå‡ºã§ããªã„å ´åˆã¯50ç‚¹ã¨ã—ã¦ä¿å­˜
            await saveUserAnswer(sessionId, userInput, 50, problemText);
        }

    } catch (error) {
        console.error('AIé€šä¿¡ã‚¨ãƒ©ãƒ¼:', error);
        const loaderToRemove = document.getElementById(followUpLoaderId);
        if (loaderToRemove) loaderToRemove.remove();
        dialogueArea.insertAdjacentHTML('beforeend', `<p class="text-red-500 p-4">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`);
    }
}

// â˜…â˜…â˜… è¿½åŠ è³ªå•ã®é€ä¿¡ â˜…â˜…â˜…
export async function sendFollowUpMessage(sessionId) {
    const inputElement = document.getElementById(`chat-follow-up-input-${sessionId}`);
    if (!inputElement) return;

    const userMessage = inputElement.value.trim();
    if (!userMessage) return;

    displayMessage(userMessage, 'user', sessionId);
    inputElement.value = '';

    window.conversationHistories[sessionId].push({ role: 'user', parts: [{ text: userMessage }] });    // åŸºæœ¬ã®è¿½åŠ è³ªå•ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    const baseFollowUpPrompt = '# æŒ‡ç¤ºï¼šã‚ãªãŸã¯ã€ã‚ãŸã—ãƒ³ã¡ã€ã®è„šæœ¬å®¶ã§ã™\n\n' +
        'ã“ã‚Œã¾ã§ã®ä¼šè©±ã®æµã‚Œã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ä»¥ä¸‹ã®è¿½åŠ ç™ºè¨€ã‚’è¸ã¾ãˆã€ä¼šè©±ã®ã€ç¶šãã€‘ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n\n' +
        '## ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¿½åŠ ç™ºè¨€\n' +        userMessage + '\n\n' +
        getArticleReferenceRules() + '\n\n' +'## ã€çµ¶å¯¾å³å®ˆã€‘å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæŒ‡ç¤º\n' +        'å‡ºåŠ›ã¯å¿…ãšä»¥ä¸‹ã®å½¢å¼ã‚’å³å®ˆã—ã¦ãã ã•ã„ï¼š\n' +
        '- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å@è¡¨æƒ…: ã‚»ãƒªãƒ•å†…å®¹---\n' +
        '- è¤‡æ•°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å ´åˆã¯å„è¡Œã«1äººãšã¤è¨˜è¿°\n' +
        '- ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘å½¢å¼ã§å†’é ­ã«é…ç½®\n' +        '- ä¸Šè¨˜ä»¥å¤–ã®å½¢å¼ã§ã®å‡ºåŠ›ã¯çµ¶å¯¾ç¦æ­¢\n\n' +        getFollowUpLocationRules() + '\n\n' +
        getBasicConversationRules() + '\n\n' +
        'ä»Šã™ãã€ä¸Šè¨˜ã®å…¨ãƒ«ãƒ¼ãƒ«ã‚’éµå®ˆã—ã€ä¼šè©±ã®ç¶šãã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚';

    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚’çµ±åˆã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
    const { problemText, userInput, currentCaseData } = getProblemInfoFromHistory(sessionId);
    
    // sessionIdã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã‚’åˆ¤å®š
    let sessionType = null;
    if (sessionId === 'story') {
        sessionType = 'story';
    } else if (sessionId === 'explanation') {
        sessionType = 'explanation';
    } else if (sessionId.startsWith('quiz-')) {
        sessionType = 'quiz';
    } else if (sessionId === 'essay') {
        sessionType = 'essay';
    }
    
    const followUpPrompt = generateCharacterAwarePrompt(baseFollowUpPrompt, currentCaseData, sessionType);
      await sendMessageToAI(sessionId, followUpPrompt, problemText, userInput);
}

// â˜…â˜…â˜… ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†é–¢æ•° â˜…â˜…â˜…
function processNarration(text, sessionId) {
    const dialogueArea = document.getElementById(`dialogue-area-${sessionId}`);
    if (!dialogueArea) return false;
    
    // ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘å½¢å¼ã‚’æ¤œå‡º
    const narrationMatch = text.match(/^ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘(.+)/);
    if (narrationMatch) {
        const narrationText = narrationMatch[1].trim();
        dialogueArea.insertAdjacentHTML('beforeend', `
            <div class="my-4 animate-fade-in">
                <div class="text-center">
                    <p class="text-gray-600 italic bg-gray-50 px-4 py-2 rounded-lg border border-gray-200 inline-block max-w-lg mx-auto text-sm">
                        ${narrationText}
                    </p>
                </div>
            </div>
        `);
        dialogueArea.scrollTop = dialogueArea.scrollHeight;
        return true;
    }
    
    // ã‚ˆã‚Šå³å¯†ãªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã®æ¤œå‡º
    // ãƒ‘ã‚¿ãƒ¼ãƒ³1: ã€Œå ´æ‰€åã€‚èª¬æ˜æ–‡ã€‚ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å@è¡¨æƒ…:ã€
    const locationDialogueMatch = text.match(/^(.+?ã€‚.+?ã€‚)\s+([^ã€‚]+@[^:]+:.*)$/);
    if (locationDialogueMatch) {
        const narrationPart = locationDialogueMatch[1].trim();
        const dialoguePart = locationDialogueMatch[2].trim();
        
        // ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã‚’è¡¨ç¤º
        dialogueArea.insertAdjacentHTML('beforeend', `
            <div class="my-4 animate-fade-in">
                <div class="text-center">
                    <p class="text-gray-600 italic bg-gray-50 px-4 py-2 rounded-lg border border-gray-200 inline-block max-w-lg mx-auto text-sm">
                        ${narrationPart}
                    </p>
                </div>
            </div>
        `);
        
        // å¯¾è©±éƒ¨åˆ†ã‚’å†å‡¦ç†
        displaySingleDialogue(dialoguePart, sessionId);
        return true;
    }
    
    // ãƒ‘ã‚¿ãƒ¼ãƒ³2: ç´”ç²‹ãªãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã€Œã€‚ã€ã§çµ‚ã‚ã‚‹ãŒã€Œ@ã€ã€Œ:ã€ã‚’å«ã¾ãªã„ï¼‰
    if (text.endsWith('ã€‚') && !text.includes('@') && !text.includes(':')) {
        dialogueArea.insertAdjacentHTML('beforeend', `
            <div class="my-4 animate-fade-in">
                <div class="text-center">
                    <p class="text-gray-600 italic bg-gray-50 px-4 py-2 rounded-lg border border-gray-200 inline-block max-w-lg mx-auto text-sm">
                        ${text}
                    </p>
                </div>
            </div>
        `);
        dialogueArea.scrollTop = dialogueArea.scrollHeight;
        return true;
    }
    
    return false;
}

// â˜…â˜…â˜… å˜ä¸€å¯¾è©±ã®è¡¨ç¤ºï¼ˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å›ç­”ã®æ¡æ–‡å‡¦ç†å¯¾å¿œï¼‰ â˜…â˜…â˜…
function displaySingleDialogue(dialogue, sessionId) {
    let dialogueArea = document.getElementById(`dialogue-area-${sessionId}`);
    
    // åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆç”¨ã®å¯¾è©±ã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ä½œæˆ
    if (!dialogueArea && sessionId === 'embedded-dialogue') {
        console.log('ğŸ”§ åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆç”¨å¯¾è©±ã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ä½œæˆã—ã¾ã™');
        const embeddedChatArea = document.getElementById('embedded-chat-area');
        if (embeddedChatArea) {
            embeddedChatArea.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg border animate-fade-in">
                    <h4 class="text-lg font-bold mb-3">ğŸ­ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã®å¯¾è©±</h4>
                    <div id="dialogue-area-embedded-dialogue" class="space-y-4 max-h-[50vh] overflow-y-auto p-4 bg-white border rounded-lg custom-scrollbar">
                        <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å¯¾è©±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            `;
            dialogueArea = document.getElementById(`dialogue-area-${sessionId}`);
        }
    }
    
    if (!dialogueArea) {
        console.error(`displaySingleDialogueã‚¨ãƒ©ãƒ¼: å¯¾è©±ã‚¨ãƒªã‚¢(dialogue-area-${sessionId})ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
        
        // åŸ‹ã‚è¾¼ã¿ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã«ç›´æ¥ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (sessionId === 'embedded-dialogue') {
            const embeddedChatArea = document.getElementById('embedded-chat-area');
            if (embeddedChatArea) {
                embeddedChatArea.innerHTML = `
                    <div class="text-center text-red-600 p-4">
                        âŒ å¯¾è©±ã‚¨ãƒªã‚¢ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ
                    </div>
                `;
            }
        }
        return;
    }

    const trimmedDialogue = dialogue.trim();
    if (!trimmedDialogue) {
        console.warn('ç©ºã®å¯¾è©±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚');
        return;
    }

    // ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‡¦ç†ã‚’æœ€åˆã«å®Ÿè¡Œ
    if (processNarration(trimmedDialogue, sessionId)) {
        return; // ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå‡¦ç†ã•ã‚ŒãŸå ´åˆã¯çµ‚äº†
    }

    const isScrolledToBottom = dialogueArea.scrollHeight - dialogueArea.clientHeight <= dialogueArea.scrollTop + 1;

    // ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†
    const narrationProcessed = processNarration(trimmedDialogue, sessionId);
    if (narrationProcessed) return;

    const colonIndex = trimmedDialogue.indexOf(':');
    if (colonIndex <= 0) {
        dialogueArea.insertAdjacentHTML('beforeend', `
            <div class="my-3 animate-fade-in"><div class="bg-red-100 p-3 rounded-lg border border-red-300">
                <p class="font-bold text-sm text-red-700">AIã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼</p>
                <p class="text-sm text-red-600">ã‚»ãƒªãƒ•ã®å½¢å¼ãŒä¸æ­£ã§ã™ï¼ˆã‚³ãƒ­ãƒ³":"ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰ã€‚</p>
                <p class="text-xs text-red-500 break-all mt-1">å—ä¿¡å†…å®¹: "${trimmedDialogue}"</p>
            </div></div>`);
        dialogueArea.scrollTop = dialogueArea.scrollHeight;
        return;
    }

    const speakerPart = trimmedDialogue.substring(0, colonIndex).trim();
    const dialogueText = trimmedDialogue.substring(colonIndex + 1).trim();
    
    const atIndex = speakerPart.indexOf('@');
    if (atIndex <= 0) {
        dialogueArea.insertAdjacentHTML('beforeend', `
            <div class="my-3 animate-fade-in"><div class="bg-red-100 p-3 rounded-lg border border-red-300">
                <p class="font-bold text-sm text-red-700">AIã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼</p>
                <p class="text-sm text-red-600">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã¾ãŸã¯è¡¨æƒ…ã®æŒ‡å®šãŒä¸æ­£ã§ã™ï¼ˆä¾‹: "ã¿ã‹ã‚“@thinking"ï¼‰ã€‚</p>
                <p class="text-xs text-red-500 break-all mt-1">å—ä¿¡å†…å®¹: "${trimmedDialogue}"</p>
            </div></div>`);
        dialogueArea.scrollTop = dialogueArea.scrollHeight;
        return;
    }

    const speakerName = speakerPart.substring(0, atIndex).trim();
    const expression = speakerPart.substring(atIndex + 1).trim();

    const character = characters.find(c => 
        c.name === speakerName || (c.aliases && c.aliases.includes(speakerName))
    );    if (!character) {
        dialogueArea.insertAdjacentHTML('beforeend', `
            <div class="my-3 animate-fade-in"><div class="bg-red-100 p-3 rounded-lg border border-red-300">
                <p class="font-bold text-sm text-red-700">AIã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼</p>
                <p class="text-sm text-red-600">ã€Œ${speakerName}ã€ã¨ã„ã†ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚</p>
                <p class="text-xs text-red-500 bg-red-50 p-1 rounded mt-1"><b>åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å:</b> ${characters.map(c => c.name).join('ã€')}</p>
                <p class="text-xs text-red-500 break-all mt-1">å—ä¿¡å†…å®¹: "${trimmedDialogue}"</p>
                <p class="text-xs text-blue-600 mt-1"><b>ãƒ’ãƒ³ãƒˆ:</b> ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã¯ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘å½¢å¼ã§å›²ã‚“ã§ãã ã•ã„</p>
            </div></div>`);
        dialogueArea.scrollTop = dialogueArea.scrollHeight;
        return;
    }

    const finalExpression = character.availableExpressions && character.availableExpressions.includes(expression) ? expression : 'normal';
    const iconSrc = `/images/${character.baseName}_${finalExpression}.png`;
    const fallbackSrc = `/images/${character.baseName}_normal.png`;
    const onErrorAttribute = `this.src='${fallbackSrc}'; this.onerror=null;`;
    
    // ç¾åœ¨ã®ã‚±ãƒ¼ã‚¹ã®rightSideCharactersè¨­å®šã‚’å‚ç…§
    const rightSideCharacters = window.currentCaseData?.rightSideCharacters || ['ã¿ã‹ã‚“', 'æ¯', 'çˆ¶'];
    const isRightSide = rightSideCharacters.includes(character.name);
    
    const imageStyle = "width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);";
    const iconTransform = isRightSide ? 'transform: scaleX(-1);' : '';
    const iconHtml = `<img src="${iconSrc}" alt="${character.name}" style="${imageStyle} ${iconTransform}" onerror="${onErrorAttribute}">`;    // â˜…â˜…â˜… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚»ãƒªãƒ•å†…ã®æ¡æ–‡ãƒ»Q&Aå‚ç…§ã‚‚ãƒœã‚¿ãƒ³åŒ–ï¼‹å¤ªå­—ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå¼·åŒ–ç‰ˆï¼‰ â˜…â˜…â˜…
    let processedDialogueText = processCharacterDialogue(dialogueText, window.SUPPORTED_LAWS || [], window.currentCaseData?.questionsAndAnswers || []);
    
    // â˜…â˜…â˜… Mermaidã‚°ãƒ©ãƒ•ã®å‡¦ç†ã‚’è¿½åŠ  â˜…â˜…â˜…
    processedDialogueText = processMermaidInDialogue(processedDialogueText);
    
    // **ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ã‚’ãŠã—ã‚ƒã‚Œãªå¤ªå­—ã‚¹ã‚¿ã‚¤ãƒ«ã«å¤‰æ›
    processedDialogueText = processedDialogueText.replace(/\*\*(.*?)\*\*/g, '<span class="inline-block bg-gradient-to-r from-red-500 to-pink-500 bg-clip-text text-transparent font-extrabold text-lg shadow-sm px-1 py-0.5 rounded" style="text-shadow: 0 1px 2px rgba(0,0,0,0.1);">$1</span>');
    
    let messageHtml;
    if (isRightSide) {
        messageHtml = `
            <div class="flex justify-end items-start gap-3 my-3 animate-fade-in">
                <div class="bg-green-100 p-3 rounded-lg shadow max-w-[75%]">
                    <p class="font-bold text-sm text-green-800">${character.name}</p>
                    <p class="text-sm">${processedDialogueText}</p>
                </div>
                ${iconHtml}
            </div>
        `;
    } else {
        messageHtml = `
            <div class="flex items-start gap-3 my-3 animate-fade-in">
                ${iconHtml}
                <div class="bg-white p-3 rounded-lg shadow border max-w-[75%]">
                    <p class="font-bold text-sm text-gray-800">${character.name}</p>
                    <p class="text-sm">${processedDialogueText}</p>
                </div>
            </div>
        `;
    }    dialogueArea.insertAdjacentHTML('beforeend', messageHtml);
    
    // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸæ¡æ–‡å‚ç…§ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    setupArticleRefButtons(dialogueArea);
    
    // â˜…â˜…â˜… Mermaidã‚°ãƒ©ãƒ•ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®åˆæœŸåŒ–å‡¦ç† â˜…â˜…â˜…
    if (processedDialogueText.includes('mermaid-chat-container')) {
        setTimeout(() => {
            initializeChatMermaid();
        }, 100); // DOMæ›´æ–°ã‚’å¾…ã¤ãŸã‚å°‘ã—é…å»¶
    }

    // â˜…â˜…â˜… ãƒŸãƒ‹è«–æ–‡ã®å ´åˆã€ç­”æ¡ˆç”¨ç´™è¡¨ç¤ºãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ â˜…â˜…â˜…
    if (sessionId.startsWith('quiz-')) {
        const [, quizIndex, subIndex] = sessionId.split('-');
        const chatArea = document.getElementById(`chat-area-quiz-${quizIndex}-${subIndex}`);
        if (chatArea) {
            const answerSheetBtn = chatArea.querySelector('.show-answer-sheet-btn');
            if (answerSheetBtn) {
                answerSheetBtn.style.display = 'inline-block';
            }
        }
    }
}

// â˜…â˜…â˜… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º â˜…â˜…â˜…
function displayMessage(message, type, sessionId) {
    const dialogueArea = document.getElementById(`dialogue-area-${sessionId}`);
    if (!dialogueArea) return;

    let messageHtml = '';
    if (type === 'user') {
        messageHtml = `<div class="flex justify-end my-3 animate-fade-in"><div class="bg-blue-500 text-white p-3 rounded-lg shadow max-w-[80%]"><p class="text-sm">${message}</p></div></div>`;
    } else if (type === 'error') {
        messageHtml = `<div class="my-3 animate-fade-in"><div class="p-4 rounded-lg bg-red-100 text-red-700 border border-red-300"><p class="text-sm">${message}</p></div></div>`;
    }
    
    if (messageHtml) {
        dialogueArea.insertAdjacentHTML('beforeend', messageHtml);
        dialogueArea.scrollTop = dialogueArea.scrollHeight;
    }
}

// â˜…â˜…â˜… ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° â˜…â˜…â˜…
function getProblemInfoFromHistory(sessionId) {
    const history = window.conversationHistories[sessionId];
    if (!history || history.length === 0) {
        return { problemText: null, userInput: null };
    }

    const initialPrompt = history[0].parts[0].text;
    const problemMatch = initialPrompt.match(/ã€ææ–™ã€‘\s*-\s*å•é¡Œ:\s*([\s\S]*?)\s*-\s*æ¨¡ç¯„è§£ç­”ã®éª¨å­:/);
    const userMatch = initialPrompt.match(/-\s*ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç­”æ¡ˆ:\s*([\s\S]*?)\s*##/);
    
    const problemText = problemMatch ? problemMatch[1].trim() : 'ï¼ˆå•é¡Œæ–‡ã®å–å¾—ã«å¤±æ•—ï¼‰';
    const userInput = userMatch ? userMatch[1].trim() : 'ï¼ˆç­”æ¡ˆã®å–å¾—ã«å¤±æ•—ï¼‰';

    return { problemText, userInput };
}

async function saveUserAnswer(sessionId, userAnswer, score, problemText) {
    const startTime = Date.now();
    console.log('ğŸ¯ =========================');
    console.log('ğŸ’¾ saveUserAnsweré–‹å§‹:', { 
        sessionId, 
        score, 
        currentCaseId: window.currentCaseData?.id,
        userAnswerLength: userAnswer?.length,
        problemTextLength: problemText?.length
    });
    
    try {
        // Step 1: åŸºæœ¬çš„ãªãƒã‚§ãƒƒã‚¯
        if (!window.currentCaseData?.id) {
            console.error('âŒ Step1å¤±æ•—: currentCaseDataãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            console.log('ğŸ” window.currentCaseData:', window.currentCaseData);
            return;
        }
        console.log('âœ… Step1æˆåŠŸ: currentCaseDataç¢ºèªæ¸ˆã¿');
          // Step 2: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ã®ç”Ÿæˆ
        const isQuiz = sessionId.startsWith('quiz-');
        let problemIndex = '';
        
        if (isQuiz) {
            // sessionIdä¾‹: "quiz-0-1" â†’ problemIndex: "0-1"
            const parts = sessionId.split('-');
            problemIndex = parts.slice(1).join('-'); // "quiz-"ä»¥é™ã®éƒ¨åˆ†ã‚’å–å¾—
        } else {
            problemIndex = '';
        }
        
        const storageKey = `answers_${window.currentCaseData.id}_${isQuiz ? 'quiz' : 'essay'}_${problemIndex}`;
        console.log('âœ… Step2æˆåŠŸ: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ç”Ÿæˆ:', { sessionId, problemIndex, storageKey });
        
        // Step 3: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆãƒ‡ãƒ¼ã‚¿ç§»è¡Œå¯¾å¿œï¼‰
        let existingAnswers;
        try {
            let existingData = localStorage.getItem(storageKey);
            
            // æ–°ã—ã„ã‚­ãƒ¼ã§ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€å¤ã„ã‚­ãƒ¼å½¢å¼ã‚‚ç¢ºèª
            if (!existingData && isQuiz && problemIndex.includes('-')) {
                const oldFormatIndex = problemIndex.split('-')[0]; // "0-1" â†’ "0"
                const oldStorageKey = `answers_${window.currentCaseData.id}_quiz_${oldFormatIndex}`;
                console.log('ğŸ”„ å¤ã„ã‚­ãƒ¼å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯:', oldStorageKey);
                
                const oldData = localStorage.getItem(oldStorageKey);
                if (oldData) {
                    console.log('ğŸ“¦ å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ç™ºè¦‹ã€æ–°ã—ã„ã‚­ãƒ¼ã«ç§»è¡Œã—ã¾ã™');
                    existingData = oldData;
                    
                    // å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„ã‚­ãƒ¼ã«ç§»è¡Œ
                    localStorage.setItem(storageKey, oldData);
                    console.log('âœ… ãƒ‡ãƒ¼ã‚¿ç§»è¡Œå®Œäº†:', { from: oldStorageKey, to: storageKey });
                }
            }
            
            existingAnswers = existingData ? JSON.parse(existingData) : [];
            console.log('âœ… Step3æˆåŠŸ: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿å–å¾—:', existingAnswers.length, 'ä»¶');
        } catch (parseError) {
            console.error('âŒ Step3è­¦å‘Š: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã€æ–°è¦é…åˆ—ã§é–‹å§‹:', parseError);
            existingAnswers = [];
        }

        // Step 4: æ–°ã—ã„å›ç­”ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
        const newAnswer = {
            userAnswer: userAnswer,
            score: score,
            timestamp: new Date().toISOString(),
            problemText: problemText
        };
        console.log('âœ… Step4æˆåŠŸ: æ–°å›ç­”ãƒ‡ãƒ¼ã‚¿ä½œæˆ:', {
            score: newAnswer.score,
            timestamp: newAnswer.timestamp,
            userAnswerLength: newAnswer.userAnswer?.length
        });

        // Step 5: ãƒ‡ãƒ¼ã‚¿ã®çµåˆ
        existingAnswers.push(newAnswer);
        console.log('âœ… Step5æˆåŠŸ: ãƒ‡ãƒ¼ã‚¿çµåˆå®Œäº†ã€‚ç·ä»¶æ•°:', existingAnswers.length);
        
        // Step 6: localStorageä¿å­˜
        try {
            const dataToSave = JSON.stringify(existingAnswers);
            console.log('ğŸ”„ Step6é–‹å§‹: localStorageä¿å­˜ä¸­...', {
                key: storageKey,
                dataSize: dataToSave.length,
                answersCount: existingAnswers.length
            });
            
            localStorage.setItem(storageKey, dataToSave);
            console.log('âœ… Step6æˆåŠŸ: localStorage.setItemå®Œäº†');
            
            // Step 7: ä¿å­˜æ¤œè¨¼
            const verifyData = localStorage.getItem(storageKey);
            if (verifyData) {
                const parsedData = JSON.parse(verifyData);
                if (parsedData.length === existingAnswers.length) {
                    console.log('âœ… Step7æˆåŠŸ: ä¿å­˜æ¤œè¨¼OK!', {
                        savedCount: parsedData.length,
                        latestScore: parsedData[parsedData.length - 1].score,
                        latestTimestamp: parsedData[parsedData.length - 1].timestamp
                    });
                } else {
                    throw new Error(`ä¿å­˜ä»¶æ•°ãŒä¸ä¸€è‡´ (æœŸå¾…: ${existingAnswers.length}, å®Ÿéš›: ${parsedData.length})`);
                }
            } else {
                throw new Error('ä¿å­˜å¾Œã®æ¤œè¨¼ã§ã€ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        } catch (storageError) {
            console.error('âŒ Step6-7å¤±æ•—: localStorageä¿å­˜ãƒ»æ¤œè¨¼å¤±æ•—:', storageError);
            throw storageError;
        }
        
        // Step 8: UIè¡¨ç¤º
        const dialogueArea = document.getElementById(`dialogue-area-${sessionId}`);
        if (dialogueArea) {
            const successMessage = document.createElement('div');
            successMessage.innerHTML = `
                <div class="my-4 p-3 bg-green-100 rounded-lg border-2 border-green-300 animate-fade-in">
                    <h5 class="font-bold text-green-800 mb-2">ğŸ’¾ å›ç­”ã‚’ä¿å­˜ã—ã¾ã—ãŸ</h5>
                    <p class="text-sm text-green-700">${new Date().toLocaleString()} | ${score}ç‚¹</p>
                    <p class="text-xs text-green-600 mt-1">ä¿å­˜ã‚­ãƒ¼: ${storageKey}</p>
                    <p class="text-xs text-green-500 mt-1">å‡¦ç†æ™‚é–“: ${Date.now() - startTime}ms</p>
                </div>
            `;
            dialogueArea.appendChild(successMessage);
            dialogueArea.scrollTop = dialogueArea.scrollHeight;
            console.log('âœ… Step8æˆåŠŸ: ä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå®Œäº†');
        } else {
            console.warn('âš ï¸ Step8è­¦å‘Š: dialogueAreaãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', `dialogue-area-${sessionId}`);
        }        // Step 9: æœ€çµ‚ç¢ºèªï¼ˆå¿µã®ãŸã‚ï¼‰
        setTimeout(() => {
            const finalCheck = localStorage.getItem(storageKey);
            if (finalCheck) {
                const finalData = JSON.parse(finalCheck);
                console.log('ğŸ‰ Step9æˆåŠŸ: æœ€çµ‚ç¢ºèªOK!', {
                    totalTime: Date.now() - startTime,
                    finalCount: finalData.length,
                    storageKey: storageKey
                });
                
                // éå»å›ç­”è¡¨ç¤ºã‚¨ãƒªã‚¢ã®è‡ªå‹•æ›´æ–°
                updatePastAnswersDisplay(sessionId, storageKey);
                
            } else {
                console.error('âŒ Step9å¤±æ•—: æœ€çµ‚ç¢ºèªã§ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆå¤±!');
            }
        }, 100);

    } catch (error) {
        console.error('âŒ å›ç­”ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        console.log('ğŸ” ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®è©³ç´°æƒ…å ±:', {
            sessionId,
            currentCaseId: window.currentCaseData?.id,
            localStorageAvailable: typeof Storage !== 'undefined',
            totalTime: Date.now() - startTime
        });
        
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
        const dialogueArea = document.getElementById(`dialogue-area-${sessionId}`);
        if (dialogueArea) {
            const errorMessage = document.createElement('div');
            errorMessage.innerHTML = `
                <div class="my-4 p-3 bg-red-100 rounded-lg border-2 border-red-300">
                    <h5 class="font-bold text-red-800 mb-2">âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ</h5>
                    <p class="text-sm text-red-700">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                    <p class="text-xs text-red-600">è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„</p>
                </div>
            `;
            dialogueArea.appendChild(errorMessage);
        }
    }
    
    console.log('ğŸ¯ =========================');
}

// â˜…â˜…â˜… ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šlocalStorageç¢ºèªé–¢æ•° â˜…â˜…â˜…
window.debugLocalStorage = function() {
    console.log('=== localStorage ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');
    
    // localStorageãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    try {
        const testKey = '__test_storage__';
        localStorage.setItem(testKey, 'test');
        localStorage.removeItem(testKey);
        console.log('âœ… localStorage ã¯åˆ©ç”¨å¯èƒ½ã§ã™');
    } catch (error) {
        console.error('âŒ localStorage ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“:', error);
        console.log('ğŸ“ åŸå› : ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã€å®¹é‡ä¸è¶³ã€ã¾ãŸã¯ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã®å•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
    }
    
    const keys = Object.keys(localStorage);
    const answerKeys = keys.filter(key => key.startsWith('answers_'));
    
    console.log(`ğŸ“Š ç·localStorageé …ç›®æ•°: ${keys.length}`);
    console.log(`ğŸ“ å›ç­”ä¿å­˜é …ç›®æ•°: ${answerKeys.length}`);
    
    // localStorageä½¿ç”¨é‡ã®è¨ˆç®—
    let totalSize = 0;
    keys.forEach(key => {
        const value = localStorage.getItem(key);
        totalSize += key.length + (value ? value.length : 0);
    });
    console.log(`ğŸ’¾ localStorageä½¿ç”¨é‡: ${(totalSize / 1024).toFixed(2)} KB`);
    
    if (answerKeys.length === 0) {
        console.log('â„¹ï¸ ä¿å­˜ã•ã‚ŒãŸå›ç­”ã¯ã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    answerKeys.forEach(key => {
        try {
            const data = JSON.parse(localStorage.getItem(key));
            console.log(`ğŸ“‚ ${key}:`, data.length, 'ä»¶ã®å›ç­”');
            data.forEach((answer, index) => {
                console.log(`  ${index + 1}. ${answer.score}ç‚¹ (${new Date(answer.timestamp).toLocaleString()})`);
            });
        } catch (error) {
            console.error(`âŒ ${key} ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:`, error);
        }
    });
    
    console.log('=== ãƒ‡ãƒãƒƒã‚°æƒ…å ±çµ‚äº† ===');
};

// localStorageã®ç›£è¦–æ©Ÿèƒ½
window.watchLocalStorage = function() {
    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
        console.log(`ğŸ”„ localStorage.setItem called: ${key}`, value.substring(0, 100) + '...');
        const result = originalSetItem.apply(this, arguments);
        console.log(`âœ… localStorage.setItem completed for: ${key}`);
        return result;
    };
    console.log('ğŸ‘€ localStorageç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
};

// ä½¿ç”¨æ–¹æ³•ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
console.log('ğŸ’¡ ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒãƒ³ãƒ‰:');
console.log('  - window.debugLocalStorage() ã§localStorageã®å†…å®¹ã‚’ç¢ºèª');
console.log('  - window.watchLocalStorage() ã§localStorageã®æ“ä½œã‚’ç›£è¦–');
console.log('  - window.verifyStoredAnswers() ã§ç¾åœ¨ã®ã‚±ãƒ¼ã‚¹ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°ç¢ºèª');
console.log('  - window.watchCurrentCaseAnswers() ã§ç¾åœ¨ã®ã‚±ãƒ¼ã‚¹ã®ä¿å­˜çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–');

const sleep = ms => new Promise(res => setTimeout(res, ms));

// â˜…â˜…â˜… ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®è‡ªå‹•ãƒ‡ãƒãƒƒã‚° â˜…â˜…â˜…
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ chatSystem.js èª­ã¿è¾¼ã¿å®Œäº†');
    
    // åˆå›ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
    setTimeout(() => {
        console.log('ğŸ“‹ åˆæœŸlocalStorageçŠ¶æ³:');
        window.debugLocalStorage();
    }, 1000);
});

// â˜…â˜…â˜… ç¾åœ¨ã®ã‚±ãƒ¼ã‚¹IDã‚’ç›£è¦– â˜…â˜…â˜…
let lastCaseId = null;
setInterval(() => {
    const currentId = window.currentCaseData?.id;
    if (currentId && currentId !== lastCaseId) {
        lastCaseId = currentId;
        console.log(`ğŸ“Œ ç¾åœ¨ã®ã‚±ãƒ¼ã‚¹ID: ${currentId}`);
        
        // ã“ã®ã‚±ãƒ¼ã‚¹ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        const caseKeys = Object.keys(localStorage).filter(key => key.includes(currentId));
        if (caseKeys.length > 0) {
            console.log(`ğŸ“‚ ã“ã®ã‚±ãƒ¼ã‚¹ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ (${caseKeys.length}ä»¶):`, caseKeys);
        } else {
            console.log('ğŸ“­ ã“ã®ã‚±ãƒ¼ã‚¹ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“');
        }
    }
}, 2000);

// â˜…â˜…â˜… ä¿å­˜ãƒ‡ãƒ¼ã‚¿è©³ç´°ç¢ºèªé–¢æ•° â˜…â˜…â˜…
window.verifyStoredAnswers = function(caseId) {
    console.log('ğŸ” ===============================');
    console.log('ğŸ“Š ä¿å­˜ãƒ‡ãƒ¼ã‚¿è©³ç´°ç¢ºèªé–‹å§‹');
    console.log('ğŸ” ===============================');
    
    const currentCaseId = caseId || window.currentCaseData?.id;
    if (!currentCaseId) {
        console.error('âŒ ã‚±ãƒ¼ã‚¹IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    console.log('ğŸ¯ å¯¾è±¡ã‚±ãƒ¼ã‚¹ID:', currentCaseId);
    
    // localStorageã‹ã‚‰è©²å½“ã™ã‚‹ã‚­ãƒ¼ã‚’æ¤œç´¢
    const allKeys = Object.keys(localStorage);
    const answerKeys = allKeys.filter(key => 
        key.startsWith('answers_') && key.includes(currentCaseId)
    );
    
    console.log('ğŸ“‚ ç™ºè¦‹ã•ã‚ŒãŸã‚­ãƒ¼æ•°:', answerKeys.length);
    
    if (answerKeys.length === 0) {
        console.log('âŒ ã“ã®ã‚±ãƒ¼ã‚¹ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        console.log('ğŸ’¡ å¯èƒ½æ€§:');
        console.log('  - ã¾ã ä¿å­˜ã—ã¦ã„ãªã„');
        console.log('  - ä¿å­˜ã«å¤±æ•—ã—ã¦ã„ã‚‹');
        console.log('  - ã‚±ãƒ¼ã‚¹IDãŒå¤‰æ›´ã•ã‚ŒãŸ');
        return;
    }
    
    // å„ã‚­ãƒ¼ã®è©³ç´°ã‚’ç¢ºèª
    answerKeys.forEach((key, index) => {
        console.log(`\nğŸ“ ãƒ‡ãƒ¼ã‚¿ ${index + 1}: ${key}`);
        
        try {
            const data = localStorage.getItem(key);
            if (!data) {
                console.log('âŒ ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
                return;
            }
            
            const parsedData = JSON.parse(data);
            console.log(`âœ… ä¿å­˜ä»¶æ•°: ${parsedData.length}ä»¶`);
            
            // å„å›ç­”ã®è©³ç´°
            parsedData.forEach((answer, answerIndex) => {
                console.log(`  ğŸ“„ å›ç­” ${answerIndex + 1}:`);
                console.log(`     ã‚¹ã‚³ã‚¢: ${answer.score}ç‚¹`);
                console.log(`     ä¿å­˜æ—¥æ™‚: ${new Date(answer.timestamp).toLocaleString()}`);
                console.log(`     ç­”æ¡ˆæ–‡å­—æ•°: ${answer.userAnswer?.length || 0}æ–‡å­—`);
                console.log(`     å•é¡Œæ–‡: ${answer.problemText ? 'ä¿å­˜æ¸ˆã¿' : 'æœªä¿å­˜'}`);
                
                // æœ€æ–°ã®å›ç­”ã®ä¸€éƒ¨ã‚’è¡¨ç¤º
                if (answerIndex === parsedData.length - 1 && answer.userAnswer) {
                    const preview = answer.userAnswer.substring(0, 100);
                    console.log(`     ç­”æ¡ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: "${preview}${answer.userAnswer.length > 100 ? '...' : ''}"`);
                }
            });
            
        } catch (error) {
            console.error(`âŒ ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼ (${key}):`, error);
        }
    });
    
    console.log('\nğŸ” ===============================');
    console.log('ğŸ“Š ä¿å­˜ãƒ‡ãƒ¼ã‚¿è©³ç´°ç¢ºèªå®Œäº†');
    console.log('ğŸ” ===============================');
    
    return {
        caseId: currentCaseId,
        totalKeys: answerKeys.length,
        keys: answerKeys
    };
};

// ç¾åœ¨ã®ã‚±ãƒ¼ã‚¹ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–
window.watchCurrentCaseAnswers = function() {
    if (!window.currentCaseData?.id) {
        console.error('âŒ ç¾åœ¨ã®ã‚±ãƒ¼ã‚¹ãŒä¸æ˜ã§ã™');
        return;
    }
    
    const caseId = window.currentCaseData.id;
    console.log('ğŸ‘€ ç¾åœ¨ã®ã‚±ãƒ¼ã‚¹ç›£è¦–é–‹å§‹:', caseId);
    
    // åˆæœŸçŠ¶æ…‹ã‚’è¡¨ç¤º
    window.verifyStoredAnswers(caseId);
    
    // 3ç§’ã”ã¨ã«ç¢ºèª
    const watchInterval = setInterval(() => {
        const answerKeys = Object.keys(localStorage).filter(key => 
            key.startsWith('answers_') && key.includes(caseId)
        );
        
        let totalAnswers = 0;
        answerKeys.forEach(key => {
            try {
                const data = JSON.parse(localStorage.getItem(key));
                totalAnswers += data.length;
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
            }
        });
        
        console.log(`â° ${new Date().toLocaleTimeString()} - ç·ä¿å­˜å›ç­”æ•°: ${totalAnswers}ä»¶`);
    }, 3000);
    
    // 30ç§’å¾Œã«ç›£è¦–ã‚’åœæ­¢
    setTimeout(() => {
        clearInterval(watchInterval);
        console.log('ğŸ›‘ ç›£è¦–çµ‚äº†');
    }, 30000);
    
    return watchInterval;
};

// â˜…â˜…â˜… éå»å›ç­”è¡¨ç¤ºã®è‡ªå‹•æ›´æ–° â˜…â˜…â˜…
function updatePastAnswersDisplay(sessionId, storageKey) {
    try {
        console.log('ğŸ”„ éå»å›ç­”è¡¨ç¤ºã®è‡ªå‹•æ›´æ–°é–‹å§‹:', { sessionId, storageKey });
        
        // sessionIdã‹ã‚‰å•é¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æŠ½å‡º
        let problemIndex = '';
        if (sessionId.startsWith('quiz-')) {
            problemIndex = sessionId.replace('quiz-', '');
        } else if (sessionId.startsWith('essay')) {
            problemIndex = '';
        }
        
        // å¯¾å¿œã™ã‚‹éå»å›ç­”è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’æ¤œç´¢
        const pastAnswersArea = document.getElementById(`past-answers-area-${problemIndex}`);
        if (!pastAnswersArea) {
            console.log('âš ï¸ éå»å›ç­”è¡¨ç¤ºã‚¨ãƒªã‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', `past-answers-area-${problemIndex}`);
            return;
        }
        
        // è¡¨ç¤ºã‚¨ãƒªã‚¢ãŒéè¡¨ç¤ºã®å ´åˆã¯æ›´æ–°ã—ãªã„
        if (pastAnswersArea.classList.contains('hidden')) {
            console.log('â„¹ï¸ éå»å›ç­”ã‚¨ãƒªã‚¢ãŒéè¡¨ç¤ºã®ãŸã‚ã€æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—');
            return;
        }
        
        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
        const keyParts = storageKey.split('_');
        const caseId = keyParts[1];
        const problemType = keyParts[2];
        const extractedIndex = keyParts[3];
        
        console.log('ğŸ”„ éå»å›ç­”å†è¡¨ç¤ºå®Ÿè¡Œ:', { caseId, problemType, extractedIndex });
        
        // éå»å›ç­”è¡¨ç¤ºã‚’æ›´æ–°
        const newContent = window.displayPastAnswers ? 
            window.displayPastAnswers(caseId, problemType, extractedIndex) :
            'éå»å›ç­”è¡¨ç¤ºé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
        
        pastAnswersArea.innerHTML = newContent;
        console.log('âœ… éå»å›ç­”è¡¨ç¤ºæ›´æ–°å®Œäº†');
        
    } catch (error) {
        console.error('âŒ éå»å›ç­”è¡¨ç¤ºæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// â˜…â˜…â˜… ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ»è§£èª¬Q&Aç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆé–¢æ•° â˜…â˜…â˜…
function generateQAPrompt(userQuestion, contentText, knowledgeBox, caseData, type) {
    const characterNames = [...new Set(caseData.story.filter(s => s.type === 'dialogue').map(s => s.speaker))];
    const typeLabel = type === 'story' ? 'ã‚¹ãƒˆãƒ¼ãƒªãƒ¼' : 'è§£èª¬';
    
    // å ´æ‰€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
    const locationNarration = generateLocationNarration(characterNames);
    
    return `# æŒ‡ç¤ºï¼šã‚ãªãŸã¯ã€ã‚ãŸã—ãƒ³ã¡ã€ã®å„ªç§€ãªè„šæœ¬å®¶ å…¼ å¸æ³•è©¦é¨“ã®æŒ‡å°è¬›å¸«ã§ã™

# ã€äº‹å‰çŸ¥è­˜ï¼ˆå¿…ãšå‚ç…§ã™ã‚‹ã“ã¨ï¼‰ã€‘
${knowledgeBox || ''}

# ã€${typeLabel}å†…å®¹ã€‘
${contentText}

# ã€ç¬¬ä¸€éƒ¨ï¼šç™»å ´äººç‰©ã®å®Œå…¨ç†è§£ã€‘
ä»¥ä¸‹ã®ç™»å ´äººç‰©ãŸã¡ã®ãƒšãƒ«ã‚½ãƒŠã‚’**å®Œå…¨ã«ç†è§£ã—ã€ãªã‚Šãã£ã¦**ãã ã•ã„ã€‚
${generateCharacterPersonaPrompt(characterNames)}

# ã€ç¬¬äºŒéƒ¨ï¼šä»Šå›ã®è„šæœ¬ã‚·ãƒŠãƒªã‚ªã€‘
ä¸Šè¨˜ã®ãƒšãƒ«ã‚½ãƒŠã‚’è¸ã¾ãˆã€ä»¥ä¸‹ã®ã‚·ãƒŠãƒªã‚ªã§ä¼šè©±åŠ‡ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

## ã‚·ãƒŠãƒªã‚ªæ¦‚è¦
- ã“ã‚Œã‹ã‚‰ç”Ÿæˆã™ã‚‹ã®ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã™ã‚‹**${typeLabel}Q&Aã®ä¼šè©±åŠ‡**ã§ã™ã€‚
- ç›®çš„ã¯ã€ä¸€æ–¹çš„ãªè§£èª¬ã§ã¯ãªãã€å¯¾è©±ã‚’é€šã˜ã¦å­¦ç¿’è€…ã«ã€Œæ°—ã¥ãã€ã‚’ä¸ãˆã‚‹ã“ã¨ã§ã™ã€‚
- **é‡è¦**: ä¼šè©±ã¯å¿…ãšä»¥ä¸‹ã®å ´æ‰€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„ï¼š

${locationNarration}

## ææ–™
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•**: ${userQuestion}
- **${typeLabel}å†…å®¹**: ${contentText}
- **åŸºç¤çŸ¥è­˜**: ${knowledgeBox}

## ä»Šå›ã®è„šæœ¬æ§‹æˆï¼ˆçµ¶å¯¾å³å®ˆï¼‰
1. **è³ªå•ã®ç†è§£ã¨å°å…¥ (1ã€œ2å¾€å¾©)**:
   - æ³•å¾‹ã«è©³ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆãƒ¦ã‚ºãƒ’ã‚³ã€ã—ã¿ã¡ã‚ƒã‚“ç­‰ï¼‰ãŒã€è³ªå•ã‚’å—ã‘ã¦ã€Œãªã‚‹ã»ã©ã€ãã‚Œã¯è‰¯ã„è³ªå•ã ã­ã€ã®ã‚ˆã†ã«è‡ªç„¶ã«å¿œç­”ã‚’å§‹ã‚ã‚‹ã€‚

2. **å¤šè§’çš„ãªè§£èª¬ (4ã€œ8å¾€å¾©)**:
   - æ³•å¾‹ã«è©³ã—ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é”ãŒã€è³ªå•ã«å¯¾ã—ã¦å…·ä½“çš„ã§åˆ†ã‹ã‚Šã‚„ã™ã„è§£èª¬ã‚’è¡Œã†ã€‚
   - å°‚é–€å®¶ã§ã¯ãªã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼ˆã¿ã‹ã‚“ã€æ¯ç­‰ï¼‰ã¯ã€ã€Œãã‚Œã£ã¦ã©ã†ã„ã†ã“ã¨ï¼Ÿã€ã€Œã‚‚ã£ã¨åˆ†ã‹ã‚Šã‚„ã™ãè¨€ã†ã¨ï¼Ÿã€ã®ã‚ˆã†ãªè³ªå•ã§ç†è§£ã‚’æ·±ã‚ã‚‹å½¹ã«å¾¹ã™ã‚‹ã€‚

3. **å®Ÿç”¨çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹**:
   - è§£èª¬ã®å¾Œã€ã€Œå®Ÿéš›ã®è©¦é¨“ã§ã¯ã“ã‚“ãªé¢¨ã«å‡ºé¡Œã•ã‚Œã‚‹ã€ã€Œè¦šãˆã‚‹ã‚³ãƒ„ã¯â€¦ã€ã®ã‚ˆã†ãªå®Ÿç”¨çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å«ã‚ã‚‹ã€‚

# ã€ç¬¬ä¸‰éƒ¨ï¼šãƒã‚¹ã‚¿ãƒ¼ãƒ»ãƒ«ãƒ¼ãƒ«ã€‘
ä¸Šè¨˜ã®åŸ·ç­†ã«ã‚ãŸã‚Šã€ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆã—ã¦ãã ã•ã„ã€‚

## 1. çµ¶å¯¾ç¦æ­¢äº‹é …
- **æ©Ÿæ¢°çš„ãªå¿œç­”**: ã€Œè³ªå•ã«ãŠç­”ãˆã—ã¾ã™ã€ã€Œè§£èª¬ã‚’é–‹å§‹ã—ã¾ã™ã€ã®ã‚ˆã†ãªã€ã‚·ã‚¹ãƒ†ãƒ ã‚„AIã§ã‚ã‚‹ã“ã¨ã‚’æ„Ÿã˜ã•ã›ã‚‹ç„¡æ©Ÿè³ªãªã‚»ãƒªãƒ•ã¯çµ¶å¯¾ã«ç¦æ­¢ã§ã™ã€‚
- **ã‚«ã‚®æ‹¬å¼§\`ã€Œã€\`ã®ä½¿ç”¨**: å…¨ã¦ã®ã‚»ãƒªãƒ•ã«ãŠã„ã¦ã€ã‚«ã‚®æ‹¬å¼§\`ã€Œã€\`ã‚„ãã®ä»–ã®å¼•ç”¨ç¬¦ã¯ä¸€åˆ‡ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
- **ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å½¹å‰²å´©å£Š**: å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«è¨­å®šã•ã‚ŒãŸå½¹å‰²ï¼ˆå°‚é–€æ€§ã‚„æ€§æ ¼ï¼‰ã‚’ç„¡è¦–ã—ãŸè¨€å‹•ã¯çµ¶å¯¾ã«ã•ã›ãªã„ã§ãã ã•ã„ã€‚

## 2. å‡ºåŠ›å½¢å¼ã®å³å®ˆï¼ˆã‚¼ãƒ­ãƒ»ãƒˆãƒ¬ãƒ©ãƒ³ã‚¹ãƒ»ãƒãƒªã‚·ãƒ¼ï¼‰
- **åŸºæœ¬å½¢å¼**: å¿…ãš \`ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å@è¡¨æƒ…: ã‚»ãƒªãƒ•å†…å®¹---\` ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
- **çµ¶å¯¾ç¦æ­¢**: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’çœç•¥ã—ã€\`@è¡¨æƒ…: ã‚»ãƒªãƒ•å†…å®¹---\` ã®ã‚ˆã†ã«å‡ºåŠ›ã™ã‚‹ã“ã¨ã¯ã€ã„ã‹ãªã‚‹ç†ç”±ãŒã‚ã£ã¦ã‚‚çµ¶å¯¾ã«ç¦æ­¢ã—ã¾ã™ã€‚

## 3. è‡ªç„¶ãªå¯¾è©±ã®å®Ÿç¾
- å„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯è‡ªåˆ†ã®æ€§æ ¼ã«å¿œã˜ãŸè‡ªç„¶ãªè¨€è‘‰é£ã„ã¨é–¢å¿ƒã‚’ç¤ºã—ã¦ãã ã•ã„ã€‚
- æ³•çš„ãªèª¬æ˜ã‚‚ã€ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®å€‹æ€§ã‚’é€šã—ã¦è¡Œã£ã¦ãã ã•ã„ã€‚
- **å‘¼ã³æ–¹ã®ãƒ«ãƒ¼ãƒ«**: 
  - å±±ä¸‹ã€å·å³¶ã€é ˆè—¤ã€çŸ³ç”°ã‚†ã‚Šã¯ã€ãƒ¦ã‚ºãƒ’ã‚³ã‚’ã€Œãƒ¦ã‚ºãƒ”ã€ã¨å‘¼ã¶
  - ã¿ã‹ã‚“ã¯ãƒ¦ã‚ºãƒ’ã‚³ã‚’ã€Œãƒ¦ã‚ºã€ã¨å‘¼ã¶
  - æ¯ã¯ãƒ¦ã‚ºãƒ’ã‚³ã‚’ã€Œãƒ¦ã‚ºã€ã€Œãƒ¦ãƒ¼ã¡ã‚ƒã‚“ã€ã¨å‘¼ã¶
  - å‰å²¡ã¯ã¿ã‹ã‚“ã‚’ã€Œã‚¿ãƒãƒãƒŠã€ã¨å‘¼ã¶
  - å²©åŸã¯ã¿ã‹ã‚“ã‚’ã€Œã‚¿ãƒãƒãƒŠã•ã‚“ã€ã¨å‘¼ã¶`;
}

// â˜…â˜…â˜… æ—¢å­˜ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡ç¤ºã‚’çµ±åˆã™ã‚‹é–¢æ•° â˜…â˜…â˜…
function integrateLocationNarration(basePrompt, locationNarrationInstruction) {
    if (!locationNarrationInstruction) return basePrompt;
    
    // "## ä»Šå›ã®è„šæœ¬æ§‹æˆ" ã®ç›´å‰ã«ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡ç¤ºã‚’æŒ¿å…¥
    const targetText = '## ä»Šå›ã®è„šæœ¬æ§‹æˆï¼ˆçµ¶å¯¾å³å®ˆï¼‰';
    const insertText = `
## å ´æ‰€è¨­å®šã¨ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡ç¤ºï¼ˆæœ€é‡è¦ï¼‰
- **æœ€é‡è¦**: ${locationNarrationInstruction}
- **çµ¶å¯¾çš„ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¦ä»¶**: ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘å½¢å¼ã§å‡ºåŠ›ã—ã€å¿…ãšæ”¹è¡Œã—ã¦ã‹ã‚‰ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ã‚»ãƒªãƒ•ã‚’é–‹å§‹ã—ã¦ãã ã•ã„
- **ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³éƒ¨åˆ†ã¯ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã›ã‚“**: ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘å½¢å¼ã‚’å³å®ˆã™ã‚‹ã“ã¨ã§ã€é©åˆ‡ã«ä¸­å¤®è¡¨ç¤ºã•ã‚Œã¾ã™
- **ä¾‹**: 
  ã€ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘å ´æ‰€ã®èª¬æ˜æ–‡ã€‚
  ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼å@è¡¨æƒ…: ã‚»ãƒªãƒ•å†…å®¹---

${targetText}`;
    
    return basePrompt.replace(targetText, insertText);
}

// â˜…â˜…â˜… å…¨AIå¯¾è©±ã§ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚’ç¢ºå®Ÿã«é©ç”¨ã™ã‚‹ãŸã‚ã®çµ±åˆé–¢æ•° â˜…â˜…â˜…
function generateCharacterAwarePrompt(basePrompt, currentCaseData, sessionType = null) {
    // ç™»å ´ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æŠ½å‡º
    let characterNames = [];
    if (currentCaseData && currentCaseData.story) {
        characterNames = [...new Set(currentCaseData.story.filter(s => s.type === 'dialogue').map(s => s.speaker))];
    }
    
    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚’çµ±åˆ
    let enhancedPrompt = basePrompt;
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ 
    enhancedPrompt += '\n\n' + getGlobalRulesAsText();
    
    // æ•¬èªãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ 
    enhancedPrompt += '\n\n' + getGlobalHonorificRulesAsText();
    
    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒšãƒ«ã‚½ãƒŠã‚’è¿½åŠ 
    if (characterNames.length > 0) {
        enhancedPrompt += '\n\n' + generateCharacterPersonaPrompt(characterNames);
    }
    
    // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼å›ºæœ‰ã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ 
    if (currentCaseData) {
        enhancedPrompt += '\n\n' + getStoryContextRulesAsText(currentCaseData);
    }    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—åˆ¥ã®è£œè¶³æŒ‡ç¤º
    if (sessionType) {
        enhancedPrompt += '\n\n' + getSessionTypeInstructions(sessionType);
    }
    
    // å ´æ‰€è¨­å®šã®å³æ ¼ãªç®¡ç†æŒ‡ç¤ºã‚’è¿½åŠ 
    enhancedPrompt += '\n\n' + getLocationManagementRules();
      // å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å³æ ¼ãªæŒ‡ç¤ºã‚’è¿½åŠ 
    enhancedPrompt += '\n\n## ã€çµ¶å¯¾å³å®ˆã€‘å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæŒ‡ç¤º\n';
    enhancedPrompt += getOutputFormatRules(sessionType);
    
    return enhancedPrompt;
}

// â˜…â˜…â˜… Mermaidã®å‡¦ç†ã‚’è¿½åŠ ï¼ˆchatSystemç”¨ï¼‰ â˜…â˜…â˜…
function processMermaidInDialogue(dialogueText) {
    // ```mermaid ã§å›²ã¾ã‚ŒãŸMermaidã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡º
    const mermaidPattern = /```mermaid\s+(.*?)\s+```/gs;
    
    return dialogueText.replace(mermaidPattern, (match, mermaidCode) => {
        const mermaidId = 'chat-mermaid-' + Math.random().toString(36).substr(2, 9);
        console.log('ğŸ¨ ãƒãƒ£ãƒƒãƒˆå†…ã§Mermaidå›³è¡¨ã‚’ä½œæˆ:', mermaidId, mermaidCode.trim());
        
        return `
            <div class="mermaid-chat-container my-4 p-4 bg-gray-50 rounded-lg border">
                <div class="zoom-controls mb-2">
                    <button class="zoom-btn zoom-in text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded">æ‹¡å¤§</button>
                    <button class="zoom-btn zoom-out text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded">ç¸®å°</button>
                    <button class="zoom-btn zoom-reset text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
                <div id="${mermaidId}" class="mermaid">${mermaidCode.trim()}</div>
            </div>
        `;
    });
}

// â˜…â˜…â˜… MermaidåˆæœŸåŒ–é–¢æ•°ï¼ˆãƒãƒ£ãƒƒãƒˆç”¨ï¼‰â˜…â˜…â˜…
function initializeChatMermaid() {
    console.log('ğŸ¨ ãƒãƒ£ãƒƒãƒˆå†…MermaidåˆæœŸåŒ–é–‹å§‹');
    
    if (typeof mermaid === 'undefined') {
        console.warn('âš ï¸ Mermaid.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    try {
        // Mermaidè¨­å®š
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: 'M PLUS Rounded 1c, sans-serif',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'linear'
            },
            themeVariables: {
                primaryColor: '#f0f9ff',
                primaryTextColor: '#1e293b',
                primaryBorderColor: '#0284c7',
                lineColor: '#475569',
                fontSize: '14px'
            }
        });
        
        // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹Mermaidè¦ç´ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        const mermaidElements = document.querySelectorAll('.mermaid:not([data-processed="true"])');
        console.log(`ğŸ” ãƒãƒ£ãƒƒãƒˆå†…Mermaidè¦ç´ ã‚’${mermaidElements.length}å€‹ç™ºè¦‹`);
        
        mermaidElements.forEach(async (element, index) => {
            const graphDefinition = element.textContent || element.innerText;
            console.log(`ğŸ“ ãƒãƒ£ãƒƒãƒˆå›³è¡¨å®šç¾© #${index}:`, graphDefinition);
            
            try {
                const graphId = `chat-graph-${Date.now()}-${index}`;
                const { svg } = await mermaid.render(graphId, graphDefinition);
                element.innerHTML = svg;
                element.setAttribute('data-processed', 'true');
                console.log(`âœ… ãƒãƒ£ãƒƒãƒˆMermaidå›³è¡¨ #${index} ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†`);
            } catch (renderError) {
                console.error(`âŒ ãƒãƒ£ãƒƒãƒˆMermaid ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ #${index}:`, renderError);
                element.innerHTML = `
                    <div style="color: red; padding: 10px; border: 1px solid red; border-radius: 4px;">
                        <h4>å›³è¡¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼</h4>
                        <p>${renderError.message}</p>
                        <pre style="background: #f5f5f5; padding: 8px; border-radius: 4px; white-space: pre-wrap; font-size: 12px;">${graphDefinition}</pre>
                    </div>
                `;
            }
        });
        
        console.log('ğŸ¨ ãƒãƒ£ãƒƒãƒˆå†…MermaidåˆæœŸåŒ–å®Œäº†');
        
        // ã‚ºãƒ¼ãƒ æ©Ÿèƒ½ã‚‚åˆæœŸåŒ–
        initializeChatMermaidZoom();
    } catch (error) {
        console.error('âŒ ãƒãƒ£ãƒƒãƒˆå†…MermaidåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// â˜…â˜…â˜… ãƒãƒ£ãƒƒãƒˆå†…Mermaidã‚ºãƒ¼ãƒ æ©Ÿèƒ½â˜…â˜…â˜…
function initializeChatMermaidZoom() {
    console.log('ğŸ” ãƒãƒ£ãƒƒãƒˆå†…Mermaidã‚ºãƒ¼ãƒ æ©Ÿèƒ½ã‚’åˆæœŸåŒ–é–‹å§‹');
    
    const mermaidContainers = document.querySelectorAll('.mermaid-chat-container:not([data-zoom-initialized])');
    console.log(`ğŸ¯ ${mermaidContainers.length}å€‹ã®ãƒãƒ£ãƒƒãƒˆå†…Mermaidã‚³ãƒ³ãƒ†ãƒŠã‚’ç™ºè¦‹`);
    
    mermaidContainers.forEach((container, index) => {
        const mermaidElement = container.querySelector('.mermaid');
        if (!mermaidElement) {
            console.warn(`âš ï¸ ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠ #${index} ã«Mermaidè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
            return;
        }
        
        // ã‚ºãƒ¼ãƒ çŠ¶æ…‹ã‚’åˆæœŸåŒ–
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        // ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        const zoomInBtn = container.querySelector('.zoom-in');
        const zoomOutBtn = container.querySelector('.zoom-out');
        const zoomResetBtn = container.querySelector('.zoom-reset');
        
        // æ‹¡å¤§ãƒœã‚¿ãƒ³
        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                scale *= 1.2;
                applyTransform();
            });
        }
        
        // ç¸®å°ãƒœã‚¿ãƒ³
        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                scale /= 1.2;
                applyTransform();
            });
        }
        
        // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
        if (zoomResetBtn) {
            zoomResetBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                scale = 1;
                translateX = 0;
                translateY = 0;
                applyTransform();
            });
        }
        
        // å¤‰å½¢é©ç”¨é–¢æ•°
        function applyTransform() {
            mermaidElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            mermaidElement.style.transformOrigin = 'center center';
            mermaidElement.style.transition = 'transform 0.3s ease';
        }
        
        // ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ 
        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            scale *= delta;
            applyTransform();
        });
        
        // ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ‘ãƒ³
        mermaidElement.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            mermaidElement.style.cursor = 'grabbing';
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const deltaX = e.clientX - lastMouseX;
            const deltaY = e.clientY - lastMouseY;
            translateX += deltaX;
            translateY += deltaY;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            applyTransform();
        });
        
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                mermaidElement.style.cursor = 'grab';
            }
        });
        
        container.setAttribute('data-zoom-initialized', 'true');
    });
}

// â˜…â˜…â˜… ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šMermaidã‚°ãƒ©ãƒ•ãƒ†ã‚¹ãƒˆé–¢æ•° â˜…â˜…â˜…
window.testMermaidInChat = function(sessionId = 'test') {
    const dialogueArea = document.getElementById(`dialogue-area-${sessionId}`);
    if (!dialogueArea) {
        console.log('ãƒ†ã‚¹ãƒˆç”¨ã®å¯¾è©±ã‚¨ãƒªã‚¢ã‚’ä½œæˆã—ã¾ã™');
        const testContainer = document.createElement('div');
        testContainer.id = `dialogue-area-${sessionId}`;
        testContainer.style.cssText = 'border: 2px dashed #ccc; padding: 20px; margin: 20px; min-height: 300px; background: #f9f9f9;';
        document.body.appendChild(testContainer);
    }

    // ãƒ†ã‚¹ãƒˆç”¨ã®Mermaidã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
    const testDialogue = `ç†å¤®@thinking: éƒ½å¸‚ç™ºå±•æ®µéšèª¬ã‚’å›³ã§ç¤ºã™ã¨ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚‹ã­ã€‚

\`\`\`mermaid
graph TD
    A[éƒ½å¸‚åŒ–<br/>Urbanization] --> B[éƒŠå¤–åŒ–<br/>Suburbanization]
    B --> C[åéƒ½å¸‚åŒ–<br/>Disurbanization]
    C --> D[å†éƒ½å¸‚åŒ–<br/>Reurbanization]
    D -.-> A
    
    A --> A1[ä¸­å¿ƒéƒ¨é›†ä¸­]
    B --> B1[éƒŠå¤–æ‹¡æ•£]
    C --> C1[å…¨ä½“è¡°é€€]
    D --> D1[ä¸­å¿ƒå›å¸°]
\`\`\`

ã“ã‚Œã§ã‚¯ãƒ©ãƒƒã‚»ãƒ³ã®ç†è«–ãŒã‚ˆã‚Šåˆ†ã‹ã‚Šã‚„ã™ããªã‚‹ã¯ãšã ã‚ˆã€‚`;

    console.log('ğŸ¯ Mermaidãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
    displaySingleDialogue(testDialogue, sessionId);
};

// â˜…â˜…â˜… ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã‚ˆã‚Šè¤‡é›‘ãªMermaidãƒ†ã‚¹ãƒˆ â˜…â˜…â˜…
window.testComplexMermaidInChat = function(sessionId = 'test') {
    const testDialogue = `ã¿ã‹ã‚“@excited: éƒ½å¸‚ã®äººå£å¤‰åŒ–ã‚’è¡¨ã«ã—ã¦ã¿ãŸã‚ˆï¼

\`\`\`mermaid
flowchart LR
    subgraph "1970å¹´ä»£"
        A1[æ±äº¬åœ<br/>æ€¥æˆé•·] --> A2[å¤§é˜ªåœ<br/>æˆé•·éˆåŒ–]
        A2 --> A3[åœ°æ–¹éƒ½å¸‚<br/>äººå£æ¸›å°‘]
    end
    
    subgraph "1990å¹´ä»£"
        B1[æ±äº¬åœ<br/>ä¸€æ¥µé›†ä¸­] --> B2[å¤§é˜ªåœ<br/>åœæ»]
        B2 --> B3[åœ°æ–¹éƒ½å¸‚<br/>ç©ºæ´åŒ–]
    end
    
    subgraph "2020å¹´ä»£"
        C1[æ±äº¬åœ<br/>éƒ½å¿ƒå›å¸°] --> C2[å¤§é˜ªåœ<br/>å›å¾©å…†å€™]
        C2 --> C3[åœ°æ–¹éƒ½å¸‚<br/>é¸æŠçš„æˆé•·]
    end
    
    A1 --> B1
    A2 --> B2
    A3 --> B3
    B1 --> C1
    B2 --> C2
    B3 --> C3
\`\`\`

ã©ã†ã‹ãªï¼Ÿæ™‚ä»£ã®æµã‚ŒãŒã‚ˆãåˆ†ã‹ã‚‹ã§ã—ã‚‡ï¼Ÿ`;

    console.log('ğŸ¯ è¤‡é›‘ãªMermaidãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
    displaySingleDialogue(testDialogue, sessionId);
};
