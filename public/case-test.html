<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚±ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'M PLUS Rounded 1c', sans-serif; 
            background-color: #FFFBEB; 
        }
        .mermaid-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .mermaid {
            display: block;
            margin: 20px auto;
            min-height: 300px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-6 max-w-4xl">
        <h1 class="text-3xl font-bold text-center mb-8">æ°‘æ³•ä»£ç†åˆ¶åº¦ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="embed-container my-6">
            <h4 class="font-bold text-lg mb-2 text-gray-800">ä»£ç†é–¢ä¿‚ã®åŸºæœ¬æ§‹é€ </h4>
            <p class="text-sm text-gray-600 mb-3">ã‚·ãƒ³ãƒ—ãƒ«ãªä»£ç†é–¢ä¿‚ã®åŸºæœ¬æ§‹é€ ã§ã™ã€‚ã¾ãšåŸºæœ¬çš„ãªå›³è¡¨è¡¨ç¤ºã®ãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚</p>
            <div class="embed-content">
                <div class="mermaid-container">
                    <div class="mermaid">graph TD
    A[ã¿ã‹ã‚“] --> B[ãƒ¦ã‚ºãƒ’ã‚³]
    B --> C[ä»£ç†æ¨©ã®ç¢ºèª]
    C --> D[æœ‰åŠ¹ãªå¥‘ç´„]</div>
                </div>
            </div>
        </div>
          <div class="embed-container my-6">
            <h4 class="font-bold text-lg mb-2 text-gray-800">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼@è¡¨è¨˜ãƒ†ã‚¹ãƒˆ</h4>
            <p class="text-sm text-gray-600 mb-3">@è¡¨è¨˜ã‚’ä½¿ã£ãŸå›³è¡¨ã§ã™ã€‚ã¾ãšã¯è¡¨è¨˜ãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
            <div class="embed-content">
                <div class="mermaid-container">
                    <div class="mermaid">graph TD
    A["ã¿ã‹ã‚“@normal"] --> B["ãƒ¦ã‚ºãƒ’ã‚³@thinking"]
    B --> C["ä»£ç†æ¨©ç¢ºèª@serious"]
    C --> D["æœ‰åŠ¹ãªå¥‘ç´„@happy"]</div>
                </div>
            </div>
        </div>
        
        <div class="embed-container my-6">
            <h4 class="font-bold text-lg mb-2 text-gray-800">è¡¨è¦‹ä»£ç†ã®3é¡å‹</h4>
            <p class="text-sm text-gray-600 mb-3">è¡¨è¦‹ä»£ç†ã®åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
            <div class="embed-content">
                <div class="mermaid-container">
                    <div class="mermaid">graph TD
    subgraph "è¡¨è¦‹ä»£ç†ã®3é¡å‹"
        A[çˆ¶] --> B[ã¿ã‹ã‚“]
        A --> C[ãƒ¦ã‚ºãƒ’ã‚³]
        A --> D[ã‚†ã‹ã‚Šã‚“]
    end
    
    B --> E[é ˆè—¤]
    C --> F[çŸ³ç”°]
    D --> G[å·å³¶]</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        console.log('ğŸ“„ ã‚±ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆé–‹å§‹');
        
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆç°¡ç•¥ç‰ˆï¼‰
        const characters = {
            'ã¿ã‹ã‚“': { normal: '/images/characters/mikan/normal.png' },
            'ãƒ¦ã‚ºãƒ’ã‚³': { thinking: '/images/characters/yuzuhiko/thinking.png', normal: '/images/characters/yuzuhiko/normal.png' },
            'ä»£ç†æ¨©ç¢ºèª': { serious: '/images/characters/mikan/serious.png' },
            'æœ‰åŠ¹ãªå¥‘ç´„': { happy: '/images/characters/mikan/happy.png' }
        };
        
        // @è¡¨è¨˜ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
        function preprocessCharacterNodes(graphDefinition) {
            console.log('ğŸ”„ @è¡¨è¨˜ã®å‡¦ç†é–‹å§‹');
            
            // ã‚­ãƒ£ãƒ©å@è¡¨æƒ…ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
            const characterPattern = /\["([^"@]+)@([^"@]+)"\]/g;
            const matches = [...graphDefinition.matchAll(characterPattern)];
            
            if (matches.length === 0) {
                console.log('âš ï¸ @è¡¨è¨˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return graphDefinition;
            }
            
            console.log(`ğŸ­ ${matches.length}å€‹ã®@è¡¨è¨˜ã‚’ç™ºè¦‹`);
            
            let processedDefinition = graphDefinition;
            matches.forEach((match, index) => {
                const [fullMatch, characterName, expression] = match;
                const cleanName = characterName.trim();
                
                // @è¡¨è¨˜ã‚’å‰Šé™¤ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªåå‰ã«ç½®æ›
                const replacement = `["${cleanName}"]`;
                processedDefinition = processedDefinition.replace(fullMatch, replacement);
                
                console.log(`ğŸ”„ ç½®æ›: ${fullMatch} â†’ ${replacement}`);
            });
            
            return processedDefinition;
        }
        
        // SVGã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
        async function addCharacterImages(svgElement, originalDefinition) {
            console.log('ğŸ¨ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒè¿½åŠ é–‹å§‹');
            
            const characterPattern = /\["([^"@]+)@([^"@]+)"\]/g;
            const matches = [...originalDefinition.matchAll(characterPattern)];
            
            if (matches.length === 0) return;
            
            // SVGã®åå‰ç©ºé–“è¨­å®š
            svgElement.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
            svgElement.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
            
            let defsElement = svgElement.querySelector('defs');
            if (!defsElement) {
                defsElement = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                svgElement.insertBefore(defsElement, svgElement.firstChild);
            }
            
            matches.forEach((match, index) => {
                const [fullMatch, characterName, expression] = match;
                const cleanName = characterName.trim();
                
                console.log(`ğŸ­ ç”»åƒè¿½åŠ : ${cleanName}@${expression}`);
                
                // ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‚’æ¤œç´¢
                const textElements = svgElement.querySelectorAll('text, tspan');
                textElements.forEach(textEl => {
                    if (textEl.textContent && textEl.textContent.trim() === cleanName) {
                        console.log(`ğŸ¯ å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆç™ºè¦‹: ${cleanName}`);
                        
                        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã®ãƒ‘ã‚¹ã‚’å–å¾—
                        const imagePath = characters[cleanName] && characters[cleanName][expression] 
                            ? characters[cleanName][expression] 
                            : '/images/characters/default.png';
                        
                        // ç”»åƒè¦ç´ ã‚’ä½œæˆ
                        const imageElement = document.createElementNS('http://www.w3.org/2000/svg', 'image');
                        imageElement.setAttribute('x', textEl.getAttribute('x') - 25);
                        imageElement.setAttribute('y', textEl.getAttribute('y') - 45);
                        imageElement.setAttribute('width', '50');
                        imageElement.setAttribute('height', '50');
                        imageElement.setAttribute('href', imagePath);
                        imageElement.style.borderRadius = '50%';
                        
                        // ãƒ†ã‚­ã‚¹ãƒˆã®è¦ªè¦ç´ ã«ç”»åƒã‚’è¿½åŠ 
                        textEl.parentNode.insertBefore(imageElement, textEl);
                        
                        // ãƒ†ã‚­ã‚¹ãƒˆã®ä½ç½®ã‚’èª¿æ•´
                        textEl.setAttribute('y', parseFloat(textEl.getAttribute('y')) + 65);
                        
                        console.log(`âœ… ç”»åƒè¿½åŠ å®Œäº†: ${imagePath}`);
                    }
                });
            });
        }
        
        function initializeMermaidDiagrams() {
            console.log('ğŸ¨ MermaidåˆæœŸåŒ–é–‹å§‹');
            console.log('ğŸ” window.mermaid:', typeof mermaid);
            
            if (typeof mermaid === 'undefined') {
                console.warn('âš ï¸ Mermaid.jsãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            try {
                // æœ€ã‚‚åŸºæœ¬çš„ãªMermaidè¨­å®š
                mermaid.initialize({
                    startOnLoad: false,
                    theme: 'default',
                    securityLevel: 'loose'
                });
                console.log('âœ… MermaidåˆæœŸåŒ–è¨­å®šå®Œäº†');
                
                // ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹Mermaidè¦ç´ ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                const mermaidElements = document.querySelectorAll('.mermaid');
                console.log(`ğŸ” Mermaidè¦ç´ ã‚’${mermaidElements.length}å€‹ç™ºè¦‹`);
                  mermaidElements.forEach(async (element, index) => {
                    if (element.getAttribute('data-processed') !== 'true') {
                        const originalDefinition = element.textContent;
                        console.log(`ğŸ“ å›³è¡¨å®šç¾© #${index}:`, originalDefinition);
                        
                        // @è¡¨è¨˜ã‚’äº‹å‰å‡¦ç†
                        const processedDefinition = preprocessCharacterNodes(originalDefinition);
                        console.log(`âœ¨ å‡¦ç†å¾Œå®šç¾© #${index}:`, processedDefinition);
                        
                        try {
                            const { svg } = await mermaid.render(`graph-${index}`, processedDefinition);
                            console.log(`ğŸ¨ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æˆåŠŸ #${index}`);
                            element.innerHTML = svg;
                            element.setAttribute('data-processed', 'true');
                            
                            // SVGè¦ç´ ã‚’å–å¾—ã—ã¦ç”»åƒã‚’è¿½åŠ 
                            const svgElement = element.querySelector('svg');
                            if (svgElement) {
                                await addCharacterImages(svgElement, originalDefinition);
                            }
                            
                            console.log(`âœ… Mermaidå›³è¡¨ #${index} ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†`);
                        } catch (renderError) {
                            console.error(`âŒ Mermaid ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ #${index}:`, renderError);
                            element.innerHTML = `
                                <div style="color: red; padding: 20px; border: 2px solid red; border-radius: 8px;">
                                    <h3>å›³è¡¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼</h3>
                                    <p>${renderError.message}</p>
                                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; white-space: pre-wrap;">${originalDefinition}</pre>
                                </div>
                            `;
                        }
                    }
                });
                
                console.log('ğŸ¨ MermaidåˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('âŒ MermaidåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«Mermaidã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“„ DOMèª­ã¿è¾¼ã¿å®Œäº†');
            setTimeout(initializeMermaidDiagrams, 500);
        });
    </script>
</body>
</html>
